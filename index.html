<!DOCTYPE html>
<html lang="km" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>វត្តមានសិស្ស - គណិត & វិទ្យាសាស្ត្រ</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #4361ee;
      --primary-soft: #4895ef;
      --success: #4cc9f0;
      --warning: #f8961e;
      --danger: #f72585;
      --today: #22c55e;
      --bg: #f0f4f8;
      --card-bg: rgba(255, 255, 255, 0.75);
      --text: #1d3557;
      --text-muted: #6c757d;
      --radius: 16px;
      --shadow-soft: 0 8px 32px rgba(31, 38, 135, 0.12);
      --transition: all 0.28s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; }

    body {
      background: linear-gradient(135deg, #e0e7ff 0%, #f0f4f8 100%);
      font-family: 'Noto Sans Khmer', system-ui, sans-serif;
      color: var(--text);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    .container-fluid { padding: 16px; max-width: 960px; margin: 0 auto; }

    .header-title { font-weight: 700; color: var(--primary); letter-spacing: -0.5px; }

    .score-card {
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: var(--shadow-soft);
      padding: 20px;
      margin: 16px 0;
      text-align: center;
      transition: var(--transition);
    }

    .score-card:hover { transform: translateY(-4px); box-shadow: 0 16px 40px rgba(67,97,238,0.18); }

    .search-group { position: relative; margin-bottom: 12px; }

    .search-input {
      border-radius: 50px;
      padding: 14px 20px 14px 48px;
      border: 1px solid rgba(67,97,238,0.3);
      background: white;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
      transition: var(--transition);
    }

    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(67,97,238,0.15);
      outline: none;
    }

    .btn-export, .btn-load-more {
      border-radius: 50px;
      padding: 12px 24px;
      font-weight: 600;
      transition: var(--transition);
    }

    .btn-export {
      background: #10b981;
      border: none;
      color: white;
      box-shadow: 0 4px 14px rgba(16,185,129,0.3);
    }

    .btn-load-more {
      background: var(--primary);
      border: none;
      color: white;
      box-shadow: 0 4px 14px rgba(67,97,238,0.3);
      margin: 20px auto;
      display: block;
    }

    .btn-add {
      border-radius: 50px;
      padding: 14px 28px;
      font-weight: 600;
      background: var(--primary);
      border: none;
      box-shadow: 0 6px 20px rgba(67,97,238,0.3);
    }

    .btn-add:active, .btn-export:active, .btn-load-more:active { transform: scale(0.97); }

    .student-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
      overflow: hidden;
      transition: var(--transition);
    }

    .student-header {
      padding: 16px 20px;
      background: linear-gradient(90deg, rgba(67,97,238,0.08), rgba(72,149,239,0.05));
      border-bottom: 1px solid rgba(255,255,255,0.4);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .student-name { font-weight: 600; font-size: 1.1rem; margin: 0; flex: 1; }

    .badge-sex { font-size: 0.8rem; padding: 6px 12px; border-radius: 50px; }

    .attendance-section { padding: 12px 16px; }

    .day-labels {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      text-align: center;
      margin-bottom: 8px;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .day-labels .today-label {
      color: var(--today);
      font-weight: 700;
      text-shadow: 0 0 6px rgba(34,197,94,0.4);
    }

    .attendance-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      text-align: center;
    }

    .day-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .day-cell.today {
      box-shadow: 0 0 0 3px var(--today), inset 0 0 10px rgba(34,197,94,0.25);
      transform: scale(1.06);
      z-index: 1;
    }

    .day-cell::after {
      content: '';
      position: absolute;
      width: 0; height: 0;
      background: rgba(255,255,255,0.4);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
      pointer-events: none;
    }

    .day-cell:active::after {
      width: 200px; height: 200px; opacity: 0;
    }

    .present-weekday  { background: #fff200; color: #1d3557; }
    .present-weekend  { background: #ff6b6b; color: white; }
    .absent           { background: rgba(255,255,255,0.5); color: #6c757d; }

    .stats-row {
      padding: 0 16px 16px;
      display: flex;
      justify-content: space-between;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      padding: 0 16px 16px;
    }

    .btn-action {
      flex: 1;
      border-radius: 12px;
      padding: 10px;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .btn-action:active { transform: scale(0.97); }

    #toast-container {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1090;
      max-width: 90%;
    }

    .toast { border-radius: 12px; overflow: hidden; }

    .load-more-container { text-align: center; margin: 30px 0; }

    @media (max-width: 576px) {
      .container-fluid { padding: 12px; }
      .day-labels, .attendance-grid { gap: 6px; }
      .day-cell { font-size: 0.82rem; }
      .day-labels { font-size: 0.72rem; }
    }
  </style>
</head>
<body>

<div id="app" class="container-fluid">

  <div class="text-center mb-4">
    <h4 class="header-title">សាលាគណិតវិទ្យា និងវិទ្យាសាស្ត្រ</h4>
  </div>

  <div class="score-card">
    <strong class="fs-5">ពិន្ទុវត្តមានសរុប៖ ១០០</strong><br>
    <div class="mt-2">
      ឆ្នាំ៖ <strong>{{ currentYear }}-{{ currentYear + 1 }}</strong> •
      ខែ៖ <strong>{{ currentMonthKh }}</strong> •
      ថ្ងៃសរុប៖ <strong>៧</strong>
    </div>
  </div>

  <div class="row g-2 mb-4 align-items-center">
    <div class="col-7 col-sm-6">
      <div class="search-group">
        <input v-model.trim="searchText" type="search" class="form-control search-input" placeholder="ស្វែងរកឈ្មោះ...">
      </div>
    </div>
    <div class="col-5 col-sm-3 text-end">
      <button class="btn btn-primary btn-add shadow" @click="openAddModal">
        + បន្ថែម
      </button>
    </div>
    <div class="col-12 col-sm-3 text-end mt-2 mt-sm-0">
      <button class="btn btn-export shadow" @click="exportToExcel">
        នាំចេញទៅ Excel
      </button>
    </div>
  </div>

  <!-- Paginated student list -->
  <div v-for="(student, idx) in paginatedStudents" :key="idx" class="student-card">
    <div class="student-header">
      <div class="student-name">{{ student.name }}</div>
      <span class="badge-sex" :class="student.sex === 'ប្រុស' ? 'bg-primary text-white' : 'bg-danger text-white'">
        {{ student.sex }}
      </span>
    </div>

    <div class="attendance-section">
      <div class="day-labels">
        <div :class="{ 'today-label': todayIndex === 0 }">ចន្ទ</div>
        <div :class="{ 'today-label': todayIndex === 1 }">អង្គារ</div>
        <div :class="{ 'today-label': todayIndex === 2 }">ពុធ</div>
        <div :class="{ 'today-label': todayIndex === 3 }">ព្រហស្បតិ៍</div>
        <div :class="{ 'today-label': todayIndex === 4 }">សុក្រ</div>
        <div :class="{ 'today-label': todayIndex === 5 }">សៅរ៍</div>
        <div :class="{ 'today-label': todayIndex === 6 }">អាទិត្យ</div>
      </div>

      <div class="attendance-grid">
        <div v-for="(val, i) in student.days" :key="i"
             class="day-cell"
             :class="[
               val ? (i >= 5 ? 'present-weekend' : 'present-weekday') : 'absent',
               i === todayIndex ? 'today' : ''
             ]"
             @click="toggleAttendance(idx, i)">
          {{ val ? 'មក' : 'អត់' }}
        </div>
      </div>
    </div>

    <div class="stats-row">
      <div>មក (ចន្ទ–អាទិត្យ)៖ <span class="text-primary">{{ student.weekdayPresent }}</span></div>
      <div>ភាគរយ៖ <span :class="student.percentage >= 80 ? 'text-success' : 'text-danger'">{{ student.percentage }}%</span></div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-outline-primary btn-action" @click="openEditModal(idx)">កែ</button>
      <button class="btn btn-outline-danger btn-action" @click="confirmDelete(idx)">លុប</button>
    </div>
  </div>

  <!-- Load More Button -->
  <div v-if="hasMore" class="load-more-container">
    <button class="btn btn-primary btn-load-more" @click="loadMore">
      បង្ហាញសិស្សបន្ថែមទៀត (១៥)
    </button>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:20px; border:none; box-shadow:0 20px 60px rgba(0,0,0,0.2);">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">{{ modalTitle }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-medium">ឈ្មោះសិស្ស</label>
            <input v-model.trim="modalName" class="form-control" required autofocus style="border-radius:12px;">
          </div>
          <div class="mb-3">
            <label class="form-label fw-medium">ភេទ</label>
            <select v-model="modalSex" class="form-select" style="border-radius:12px;">
              <option value="ប្រុស">ប្រុស</option>
              <option value="ស្រី">ស្រី</option>
            </select>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">បិទ</button>
          <button class="btn btn-primary rounded-pill px-4" @click="saveStudent">រក្សាទុក</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirm -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:20px;">
        <div class="modal-header bg-danger text-white border-0">
          <h5 class="modal-title">បញ្ជាក់ការលុប</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          តើអ្នកប្រាកដជាចង់លុប <strong>{{ studentToDeleteName }}</strong> មែនទេ?
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">បោះបង់</button>
          <button class="btn btn-danger rounded-pill px-4" @click="deleteConfirmed">លុប</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const { createApp, ref, computed } = Vue;

createApp({
  setup() {
    const totalSchoolDays = 7;
    const pageSize = 15; // show 15 students per page

    const now = new Date();
    const currentYear = now.getFullYear();
    const monthNamesKh = ["មករា","កុម្ភៈ","មីនា","មេសា","ឧសភា","មិថុនា","កក្កដា","សីហា","កញ្ញា","តុលា","វិច្ឆិកា","ធ្នូ"];
    const currentMonthKh = monthNamesKh[now.getMonth()];

    const todayIndex = (now.getDay() + 6) % 7;

    // All students
    const students = ref([
      { name: "កឹម សុភា",     sex: "ប្រុស", days: Array(7).fill(0) },
      { name: "សុខ ស្រីនាង",   sex: "ស្រី", days: Array(7).fill(0) },
      { name: "រ៉ា សុភា",       sex: "ប្រុស", days: Array(7).fill(0) },
      // ... add more students here (at least 30+ to test pagination)
      // For testing: duplicate some entries
      ...Array(30).fill().map((_, i) => ({
        name: `សិស្ស លេខ ${i + 4}`,
        sex: i % 2 === 0 ? "ប្រុស" : "ស្រី",
        days: Array(7).fill(0),
        weekdayPresent: 0,
        percentage: 100
      }))
    ]);

    students.value.forEach(s => {
      s.weekdayPresent = 0;
      s.percentage = 100;
    });

    const searchText = ref('');
    const currentPage = ref(1);

    // Filtered by search
    const filtered = computed(() => {
      if (!searchText.value.trim()) return students.value;
      const term = searchText.value.toLowerCase().trim();
      return students.value.filter(s => s.name.toLowerCase().includes(term));
    });

    // Paginated view (15 at a time)
    const paginatedStudents = computed(() => {
      const start = 0;
      const end = currentPage.value * pageSize;
      return filtered.value.slice(start, end);
    });

    // Check if there are more students to load
    const hasMore = computed(() => {
      return paginatedStudents.value.length < filtered.value.length;
    });

    const loadMore = () => {
      if (hasMore.value) {
        currentPage.value++;
        // Optional: smooth scroll to bottom after load
        setTimeout(() => {
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }, 100);
      }
    };

    const filteredStudents = paginatedStudents; // alias for template

    const exportToExcel = () => {
      // Export ALL filtered students (not just current page)
      const headers = [
        "ល.រ", "ឈ្មោះ", "ភេទ",
        "ចន្ទ", "អង្គារ", "ពុធ", "ព្រហស្បតិ៍", "សុក្រ", "សៅរ៍", "អាទិត្យ",
        "មក (ចន្ទ–អាទិត្យ)", "ភាគរយ (%)"
      ];

      const data = filtered.value.map((s, index) => {
        const daysKh = s.days.map(v => v ? "មក" : "អត់");
        return [
          index + 1, s.name, s.sex,
          ...daysKh,
          s.weekdayPresent,
          s.percentage + "%"
        ];
      });

      const worksheetData = [
        [`វត្តមានសិស្ស - ${currentMonthKh} ${currentYear}`],
        [`ឆ្នាំសិក្សា ${currentYear}-${currentYear+1}`],
        [],
        headers,
        ...data
      ];

      const ws = XLSX.utils.aoa_to_sheet(worksheetData);
      ws['!cols'] = [
        { wch: 6 }, { wch: 24 }, { wch: 8 },
        ...Array(7).fill({ wch: 8 }),
        { wch: 16 }, { wch: 10 }
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "វត្តមាន");

      const fileName = `វត្តមាន_សិស្ស_${currentYear}-${String(now.getMonth()+1).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb, fileName);

      showToast("បាននាំចេញទៅ Excel រួចរាល់", "success");
    };

    // Modal logic (unchanged)
    const modalTitle = ref("បន្ថែមសិស្សថ្មី");
    const modalName = ref("");
    const modalSex = ref("ប្រុស");
    const editingIndex = ref(-1);

    const openAddModal = () => {
      modalTitle.value = "បន្ថែមសិស្សថ្មី";
      modalName.value = "";
      modalSex.value = "ប្រុស";
      editingIndex.value = -1;
      bootstrap.Modal.getOrCreateInstance(document.getElementById("studentModal")).show();
    };

    const openEditModal = (idx) => {
      const s = students.value[idx];
      modalTitle.value = "កែសម្រួលសិស្ស";
      modalName.value = s.name;
      modalSex.value = s.sex;
      editingIndex.value = idx;
      bootstrap.Modal.getOrCreateInstance(document.getElementById("studentModal")).show();
    };

    const saveStudent = () => {
      if (!modalName.value.trim()) return alert("សូមបញ្ចូលឈ្មោះ!");
      const name = modalName.value.trim();

      if (editingIndex.value === -1) {
        students.value.push({ name, sex: modalSex.value, days: Array(7).fill(0), weekdayPresent: 0, percentage: 100 });
        showToast("បន្ថែមសិស្សថ្មីជោគជ័យ", "success");
      } else {
        const s = students.value[editingIndex.value];
        s.name = name;
        s.sex = modalSex.value;
        showToast("កែសម្រួលជោគជ័យ", "info");
      }

      bootstrap.Modal.getInstance(document.getElementById("studentModal")).hide();
    };

    const studentToDeleteIndex = ref(-1);
    const studentToDeleteName = ref("");

    const confirmDelete = (idx) => {
      studentToDeleteIndex.value = idx;
      studentToDeleteName.value = students.value[idx].name;
      bootstrap.Modal.getOrCreateInstance(document.getElementById("deleteModal")).show();
    };

    const deleteConfirmed = () => {
      if (studentToDeleteIndex.value >= 0) {
        const name = students.value[studentToDeleteIndex.value].name;
        students.value.splice(studentToDeleteIndex.value, 1);
        showToast(`លុប "${name}" រួចរាល់`, "danger");
      }
      bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide();
    };

    const toggleAttendance = (idx, day) => {
      const s = students.value[idx];
      s.days[day] = !s.days[day];
      const presentCount = s.days.filter(Boolean).length;
      s.weekdayPresent = presentCount;
      s.percentage = totalSchoolDays ? Math.round(presentCount / totalSchoolDays * 100) : 0;
    };

    const showToast = (msg, bg = 'success') => {
      const t = document.createElement('div');
      t.className = `toast align-items-center text-white bg-${bg} border-0 shadow`;
      t.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.getElementById("toast-container").appendChild(t);
      new bootstrap.Toast(t, {delay:2200}).show();
      setTimeout(() => t.remove(), 2800);
    };

    return {
      currentYear, currentMonthKh,
      todayIndex,
      students,
      searchText,
      filteredStudents,
      paginatedStudents,
      hasMore,
      loadMore,
      modalTitle, modalName, modalSex,
      openAddModal, openEditModal, saveStudent,
      confirmDelete, studentToDeleteName, deleteConfirmed,
      toggleAttendance,
      exportToExcel,
      showToast
    };
  }
}).mount('#app');
</script>
</body>
</html>